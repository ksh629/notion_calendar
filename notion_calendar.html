<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notion Calendar Widget</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111;
      --muted:#6b7280;
      --card:#f8fafc;
      --line:#e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
      --radius:16px;
      --cell: 108px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;

      --rose_h: #F43F5E;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--fg); font-family:var(--font);
      display:flex; align-items:flex-start; justify-content:center;
      padding:14px;
    }
    .wrap{ width:min(900px, 100%); }
    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      background:var(--bg);
    }

    .ui-font{
      font-size:15px;
      font-weight:500;
      letter-spacing:-.2px;
    }

    header{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:#fff;
      flex-wrap:wrap;
    }
    .left, .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex:1;
      min-width:240px;
    }
    .title{ white-space:nowrap; }
    .title b{ font-weight:800; }

    button, input[type="text"]{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font:inherit;
    }
    button:hover{background:#f9fafb}
    button:active{transform:translateY(1px)}
    .btn-ghost{background:transparent}

    /* âœ… ì´ˆê¸°í™” ë²„íŠ¼: í‰ë²”í•œ í…Œë‘ë¦¬(ì¶”ê°€ ë²„íŠ¼ê³¼ ë™ì¼ í†¤) */
    .btn-danger{ border-color: var(--line); }
    .btn-danger:hover{ background:#f9fafb; }

    .bar{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:var(--card);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .label{
      font-size:12px; color:var(--muted); font-weight:900; letter-spacing:-.2px;
      padding-top:6px;
      min-width:52px;
    }

    .swatches{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .swatch{
      width:26px; height:26px; border-radius:10px; border:1px solid var(--line);
      cursor:pointer; box-shadow:0 1px 0 rgba(0,0,0,.03) inset;
    }
    .swatch.active{outline:2px solid #111; outline-offset:2px}

    .sticker-area{display:flex; flex-direction:column; gap:8px; flex:1; min-width:260px}
    .sticker-row{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .sticker{
      min-width:34px;
      height:34px;
      padding:0 10px;
      display:flex; align-items:center; justify-content:center;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .sticker.active{outline:2px solid #111; outline-offset:2px}

    .add-emoji{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .add-emoji input{
      min-width:180px;
      flex:1;
      cursor:text;
    }

    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .hint{font-size:12px; color:var(--muted); line-height:1.4}
    .hint b{color:#111}

    .calendar{ background:#fff; }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .dow div{
      padding:10px 0;
      text-align:center;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .cell{
      height:var(--cell);
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      position:relative;
      padding:10px;
      cursor:pointer;
      background:#fff;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      overflow:hidden;
    }
    .cell:nth-child(7n){border-right:none}

    .date-block{
      display:flex;
      flex-direction:column;
      gap:4px;
      z-index:1;
    }
    .num{
      font-size:14px;
      font-weight:950;
      color:#111;
      opacity:.95;
      line-height:1;
    }
    .abbr{
      font-size:11px;
      font-weight:900;
      letter-spacing:-.2px;
      line-height:1.1;
      color:#dc2626;
      opacity:.95;
      white-space:nowrap;
    }

    .cell.out .num{opacity:.35}
    .cell.out .abbr{opacity:.35}

    .cell.sat .num{ color:#2563eb; }
    .cell.sun .num{ color:#dc2626; }
    .cell.holiday .num{ color:#dc2626; }

    .cell.today{box-shadow: inset 0 0 0 1px #38BDF8;
    }


    .cell.selected{
      outline:3px solid var(--rose_h);
      outline-offset:-3px;
    }

    /* âœ… ë°°ì§€: 3x3 ìŠ¬ë¡¯ (ìŠ¤í‹°ì»¤ 2ì¤„ + +n 1ì¤„) */
    .badges{
    position:absolute;
    right:8px;
    bottom:8px;

    display:grid;
    grid-template-columns: repeat(3, 20px);
    grid-template-rows: repeat(3, 20px); /* âœ… 3ì¤„ */
    gap:4px;

    justify-content:end;
    align-content:end;
    justify-items:end;

    font-size:18px;
    line-height:1;
    z-index:1;
    }

    .badge{
    width:20px;
    height:20px;
    display:flex;
    align-items:center;
    justify-content:center;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,.06));
    }

    /* +n: 9ë²ˆì¹¸(3í–‰ 3ì—´) ê³ ì •ìœ¼ë¡œ ë„£ì„ ì˜ˆì • */
    .more{
    width:20px;
    height:18px;
    font-size:11px;
    font-weight:700;
    border:1px solid var(--line);
    border-radius:8px;
    padding:0 4px;
    background:#fff;
    color:#111;
    line-height:18px;
    cursor:default;
    display:flex;
    align-items:center;
    justify-content:center;
    }

    .selected-panel{
      padding:12px;
      background:#fff;
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:#fff;
      overflow:hidden;
    }
    .card .content{
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      cursor:pointer;
    }
    .section-head .t{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:-.2px;
    }
    .chev{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:4px 10px;
      user-select:none;
      line-height:1;
    }

    .section-body{ display:none; }
    .section-body.open{ display:block; }

    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      min-height:0;
    }
    .chip{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .chip .x{
      opacity:.6;
      cursor:pointer;
      user-select:none;
    }

    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      font:inherit;
    }

    .check-add{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:8px;
    }
    .check-add input{
      flex:1;
      min-width:220px;
      cursor:text;
    }
    .check-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .check-item{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      background:#fff;
    }
    .check-item label{
      flex:1;
      font-size:14px;
      line-height:1.3;
      cursor:pointer;
    }
    .check-item.done label{
      color:var(--muted);
      text-decoration: line-through;
    }
    .check-item .del{
      opacity:.6;
      cursor:pointer;
      user-select:none;
    }

    .footer{
      padding:10px 14px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      background:#fff;
    }
    code.k{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      background:#f3f4f6;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid #e5e7eb;
    }

    .tooltip{
      position:fixed;
      z-index:9999;
      display:none;
      max-width:260px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      font-size:13px;
      line-height:1.35;
      color:#111;
      pointer-events:none;
      white-space:normal;
    }
    .tooltip .t{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    .tooltip .s{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .tooltip .p{
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      background:#fff;
    }

    /* âœ… ëª¨ë‹¬(ë…¸ì…˜ iframeì—ì„œë„ ë™ì‘) */
    /* confirmOverlay */
    .overlay{
      position:fixed;
      inset:0;
      display:flex;
      background: rgba(17, 24, 39, .35);
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:16px;
    }

    .modal{
      margin:0 auto;
      width:min(420px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .modal-h{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }

    .modal-t{
      font-size:14px;
      font-weight:900;
      letter-spacing:-.2px;
    }

    .icon-btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:6px 10px;
      cursor:pointer;
      line-height:1;
    }
    .icon-btn:hover{ background:#f9fafb; }

    .modal-b{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .modal-msg{
      font-size:13px;
      line-height:1.45;
      color:#111;
    }
    .modal-sub{
      color:var(--muted);
      font-size:12px;
    }

    .modal-date{
      border:1px solid var(--line);
      background:#f8fafc;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      font-weight:800;
      letter-spacing:-.2px;
    }

    .modal-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .modal-actions button{
      padding:9px 12px;
      border-radius:12px;
    }

    /* âœ… ëª¨ë‹¬ 'ì´ˆê¸°í™”' ë²„íŠ¼: í†¤ ë§ì¶”ë˜ ìœ„í—˜ ì•¡ì…˜ ëŠë‚Œì€ í…ìŠ¤íŠ¸ë¡œë§Œ */
    #confirmOk{
      border:1px solid var(--line);
      background:#fff;
    }
    #confirmOk:hover{
      background:#fff5f5;
      border-color:#fecaca;
    }


  </style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <header class="ui-font">
      <div class="left">
        <button id="todayBtn" class="ui-font">Today</button>
      </div>

      <div class="center ui-font">
        <button id="prevBtn" class="btn-ghost ui-font">â†</button>
        <div class="title ui-font" id="ym"></div>
        <button id="nextBtn" class="btn-ghost ui-font">â†’</button>
      </div>

      <div class="right">
        <button id="exportBtn" class="ui-font">ë‚´ë³´ë‚´ê¸°</button>
        <button id="importBtn" class="ui-font">ê°€ì ¸ì˜¤ê¸°</button>
      </div>
    </header>

    <div class="bar">
      <div class="row">
        <div class="label">ìƒ‰</div>
        <div class="swatches" id="swatches"></div>
      </div>

      <div class="row">
        <div class="label">ìŠ¤í‹°ì»¤</div>
        <div class="sticker-area">
          <div class="sticker-row" id="stickers"></div>
          <div class="add-emoji">
            <input id="customEmoji" type="text" placeholder="ì´ëª¨ì§€ ì¶”ê°€ (ì˜ˆ: ğŸ§ , ğŸ§, ğŸ¾)" />
            <button id="addEmojiBtn">ì¶”ê°€</button>
            <button id="resetStickersBtn" class="btn-ghost">ì»¤ìŠ¤í…€ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="label">ì•¡ì…˜</div>
        <div class="actions">
          <button id="clearSelectedBtn" class="btn-danger">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <div class="calendar">
      <div class="dow">
        <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
      </div>
      <div class="grid" id="grid"></div>
    </div>

    <div class="selected-panel">
      <div class="card">
        <div class="content">
          <div><b id="pickedDate">-</b></div>

          <div class="chips" id="pickedStickers"></div>

          <div>
            <div class="section-head" id="memoHead">
              <div class="t">ë©”ëª¨</div>
              <div class="chev" id="memoChev">â–¼</div>
            </div>
            <div class="section-body" id="memoBody">
              <textarea id="memo" placeholder="ë©”ëª¨ë¥¼ ë‚¨ê²¨ë„ ë¼ìš”."></textarea>
            </div>
          </div>

          <div>
            <div class="section-head" id="checkHead">
              <div class="t">ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
              <div class="chev" id="checkChev">â–¼</div>
            </div>
            <div class="section-body" id="checkBody">
              <div class="check-add">
                <input id="checkInput" type="text" placeholder="í•  ì¼ ì¶”ê°€ (Enter ê°€ëŠ¥)" />
                <button id="addCheckBtn">ì¶”ê°€</button>
              </div>
              <div class="check-list" id="checkList"></div>
              <div class="hint">ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” ì„ íƒí•œ ë‚ ì§œì—ë§Œ ì €ì¥ë¼ìš”.</div>
            </div>
          </div>

          <div>
            <div class="section-head" id="helpHead">
              <div class="t">ì„¤ëª…</div>
              <div class="chev" id="helpChev">â–¼</div>
            </div>
            <div class="section-body" id="helpBody">
              <div class="hint" style="padding:8px 2px 0 2px;">
                - ë‚ ì§œ í´ë¦­: <b>ì„ íƒ</b><br/>
                - ìƒ‰ í´ë¦­: ì„ íƒ ë‚ ì§œ ë°°ê²½ìƒ‰ ë³€ê²½ (ìƒ‰ìƒ <b>none</b> = ìƒ‰ ì§€ìš°ê¸°)<br/>
                - ìŠ¤í‹°ì»¤ í´ë¦­: ì„ íƒ ë‚ ì§œ ìŠ¤í‹°ì»¤ <b>ì¶”ê°€/ì œê±°</b><br/>
                - â€œì´ˆê¸°í™”â€: í•´ë‹¹ ë‚ ì§œ ë°ì´í„°(ìƒ‰/ìŠ¤í‹°ì»¤/ë©”ëª¨/ì²´í¬ë¦¬ìŠ¤íŠ¸) ì‚­ì œ
              </div>
            </div>
          </div>
        </div>

        <div class="footer">
          <span class="hint">ì €ì¥ í‚¤: <code class="k" id="storageKey"></code></span>
          <span class="hint">v0.6</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmOverlay" class="overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-h">
      <div id="confirmTitle" class="modal-t">ì´ˆê¸°í™”</div>
      <button id="confirmClose" class="icon-btn" aria-label="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="modal-b">
      <div class="modal-msg">
        ì„ íƒí•œ ë‚ ì§œì˜ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?<br/>
        <span class="modal-sub">(ìƒ‰/ìŠ¤í‹°ì»¤/ë©”ëª¨/ì²´í¬ë¦¬ìŠ¤íŠ¸)</span>
      </div>

      <div class="modal-date" id="confirmDate">-</div>

      <div class="modal-actions">
        <button id="confirmCancel" class="btn-ghost ui-font">ì·¨ì†Œ</button>
        <button id="confirmOk" class="ui-font">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>
</div>


<div id="tooltip" class="tooltip"></div>

<script>
const COLORS = [
  { name: "none", value: "" },
  { name: "lemon_p", value: "#FEF08A" },
  { name: "mint_p",  value: "#A7F3D0" },
  { name: "sky_p",   value: "#BAE6FD" },
  { name: "lilac_p", value: "#DDD6FE" },
  { name: "rose_p",  value: "#FBCFE8" },
  { name: "gray_p",  value: "#E5E7EB" },
  { name: "lemon_m", value: "#FDE047" },
  { name: "mint_m",  value: "#34D399" },
  { name: "sky_m",   value: "#38BDF8" },
  { name: "lilac_m", value: "#A78BFA" },
  { name: "rose_m",  value: "#FB7185" },
  { name: "gray_m",  value: "#CBD5E1" },
  { name: "lemon_h", value: "#FACC15" },
  { name: "mint_h",  value: "#10B981" },
  { name: "sky_h",   value: "#0EA5E9" },
  { name: "lilac_h", value: "#8B5CF6" },
  { name: "rose_h",  value: "#F43F5E" },
  { name: "gray_h",  value: "#94A3B8" },
];
const BASE_STICKERS = ["", "âœ…", "ğŸ”¥", "ğŸ‰", "âœˆï¸", "ğŸ“š", "ğŸ’»", "ğŸ“", "ğŸ§˜ğŸ»â€â™€ï¸", "ğŸƒğŸ»"];

const HOLIDAYS_BY_YEAR = { /* (ë„ˆê°€ ì¤€ ê·¸ëŒ€ë¡œ ìœ ì§€) */ 
  2026: {
    "2026-01-01": "New Year's Day",
    "2026-02-16": "Seollal Holiday",
    "2026-02-17": "Seollal",
    "2026-02-18": "Seollal Holiday",
    "2026-03-01": "Independence Movement Day",
    "2026-03-02": "Substitute Holiday (Independence)",
    "2026-05-05": "Children's Day",
    "2026-05-24": "Buddha's Birthday",
    "2026-05-25": "Substitute Holiday (Buddha's Birthday)",
    "2026-06-03": "Local Election Day",
    "2026-06-06": "Memorial Day",
    "2026-08-15": "Liberation Day",
    "2026-08-17": "Substitute Holiday (Liberation Day)",
    "2026-09-24": "Chuseok Holiday",
    "2026-09-25": "Chuseok",
    "2026-09-26": "Chuseok Holiday",
    "2026-10-03": "National Foundation Day",
    "2026-10-05": "Substitute Holiday (National Foundation Day)",
    "2026-10-09": "Hangeul Day",
    "2026-12-25": "Christmas Day",
  },
  2027: {
    "2027-01-01": "New Year's Day",
    "2027-02-06": "Seollal Holiday",
    "2027-02-07": "Seollal",
    "2027-02-08": "Seollal Holiday",
    "2027-02-09": "Substitute Holiday (Seollal)",
    "2027-03-01": "Independence Movement Day",
    "2027-05-05": "Children's Day",
    "2027-05-13": "Buddha's Birthday",
    "2027-06-06": "Memorial Day",
    "2027-08-15": "Liberation Day",
    "2027-08-16": "Substitute Holiday (Liberation Day)",
    "2027-09-14": "Chuseok Holiday",
    "2027-09-15": "Chuseok",
    "2027-09-16": "Chuseok Holiday",
    "2027-10-03": "National Foundation Day",
    "2027-10-04": "Substitute Holiday (National Foundation Day)",
    "2027-10-09": "Hangeul Day",
    "2027-10-11": "Substitute Holiday (Hangeul Day)",
    "2027-12-25": "Christmas Day",
    "2027-12-27": "Substitute Holiday (Christmas)",
  },
};

function fallbackFixedHolidayName(ymd){
  const mmdd = ymd.slice(5);
  const fixed = {
    "01-01": "New Year's Day",
    "03-01": "Independence Movement Day",
    "05-05": "Children's Day",
    "06-06": "Memorial Day",
    "08-15": "Liberation Day",
    "10-03": "National Foundation Day",
    "10-09": "Hangeul Day",
    "12-25": "Christmas Day",
  };
  return fixed[mmdd] || "";
}
function holidayName(ymd){
  const y = Number(ymd.slice(0,4));
  const map = HOLIDAYS_BY_YEAR[y];
  if(map && map[ymd]) return map[ymd];
  return fallbackFixedHolidayName(ymd);
}
function holidayAbbr(ymd){
  const name = holidayName(ymd);
  if(!name) return "";
  const rules = [
    { test: /Seollal/i, abbr: "ì„¤" },
    { test: /Chuseok/i, abbr: "ì¶”ì„" },
    { test: /Buddha/i, abbr: "ë¶€ì²˜ë‹˜" },
    { test: /Substitute/i, abbr: "ëŒ€ì²´" },
    { test: /Local Election/i, abbr: "ì„ ê±°" },
    { test: /New Year/i, abbr: "ì‹ ì •" },
    { test: /Independence/i, abbr: "ì‚¼ì¼ì ˆ" },
    { test: /Children/i, abbr: "ì–´ë¦°ì´ë‚ " },
    { test: /Memorial/i, abbr: "í˜„ì¶©ì¼" },
    { test: /Liberation/i, abbr: "ê´‘ë³µì ˆ" },
    { test: /National Foundation/i, abbr: "ê°œì²œì ˆ" },
    { test: /Hangeul/i, abbr: "í•œê¸€ë‚ " },
    { test: /Christmas/i, abbr: "ì„±íƒ„ì ˆ" },
  ];
  for(const r of rules){
    if(r.test.test(name)) return r.abbr;
  }
  return "ê³µíœ´ì¼";
}

const qs = new URLSearchParams(location.search);
const WIDGET_ID = (qs.get("id") || "default").trim();
const STORAGE_KEY = `notion_calendar_widget:${WIDGET_ID}`;
const CUSTOM_STICKERS_KEY = `notion_calendar_widget_custom_stickers:${WIDGET_ID}`;

const el = (id) => document.getElementById(id);
el("confirmOverlay").hidden = true;

/* âœ… ëª¨ë‹¬ ìœ í‹¸ */
let pendingAction = null;

function openConfirmModal(dateKey){
  const ov = el("confirmOverlay");
  el("confirmDate").textContent = dateKey ? formatKoreanDateLabel(dateKey) : "-";
  ov.hidden = false;
}

function closeConfirmModal(){
  const ov = el("confirmOverlay");
  ov.hidden = true;
  pendingAction = null;
}

/* ëª¨ë‹¬ í´ë¦­/í‚¤ ì´ë²¤íŠ¸ */
el("confirmClose").addEventListener("click", closeConfirmModal);
el("confirmCancel").addEventListener("click", closeConfirmModal);
el("confirmOverlay").addEventListener("click", (e)=>{
  // ì˜¤ë²„ë ˆì´ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
  if(e.target.id === "confirmOverlay") closeConfirmModal();
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && !el("confirmOverlay").hidden){
    closeConfirmModal();
  }
});

el("confirmOk").addEventListener("click", ()=>{
  if(typeof pendingAction === "function") pendingAction();
  closeConfirmModal();
});


let state = loadState();
let view = new Date();
view.setDate(1);

let picked = null;
let activeColor = COLORS[1].value;

let stickers = loadStickers();
let activeSticker = "âœ…";

let memoOpen = false;
let checkOpen = false;
let helpOpen = false;

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    const parsed = raw ? JSON.parse(raw) : {};
    for(const k of Object.keys(parsed)){
      const v = parsed[k];
      if(v && typeof v === "object"){
        if(Array.isArray(v.stickers) === false){
          const old = v.sticker;
          v.stickers = old ? [old] : [];
          delete v.sticker;
        }
        if(typeof v.memo !== "string") v.memo = "";
        if(typeof v.color !== "string") v.color = "";
        if(Array.isArray(v.checklist) === false) v.checklist = [];
      }
    }
    return parsed;
  } catch {
    return {};
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadStickers(){
  let custom = [];
  try{
    const raw = localStorage.getItem(CUSTOM_STICKERS_KEY);
    custom = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(custom)) custom = [];
  }catch{
    custom = [];
  }
  const set = new Set(BASE_STICKERS);
  custom.forEach(s=>{ if(typeof s==="string" && s.trim()) set.add(s.trim()); });
  return Array.from(set);
}
function saveCustomStickers(arr){
  localStorage.setItem(CUSTOM_STICKERS_KEY, JSON.stringify(arr));
  stickers = loadStickers();
  renderStickerRow();
}

function fmtDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function ensurePicked(){
  if(!picked){
    alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.");
    return false;
  }
  return true;
}
function ensureDay(key){
  if(!state[key]) state[key] = { color:"", stickers:[], memo:"", checklist:[] };
  if(Array.isArray(state[key].stickers) === false) state[key].stickers = [];
  if(typeof state[key].memo !== "string") state[key].memo = "";
  if(typeof state[key].color !== "string") state[key].color = "";
  if(Array.isArray(state[key].checklist) === false) state[key].checklist = [];
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function formatKoreanDateLabel(ymd){
  const [yy, mm, dd] = ymd.split("-").map(Number);
  const d = new Date(yy, mm - 1, dd);
  const dow = ["ì¼ìš”ì¼","ì›”ìš”ì¼","í™”ìš”ì¼","ìˆ˜ìš”ì¼","ëª©ìš”ì¼","ê¸ˆìš”ì¼","í† ìš”ì¼"][d.getDay()];
  return `${yy}. ${mm}. ${dd}. ${dow}`;
}

function setBadgeSlotFixedMore(node, idx, totalIcons, hasMore){
  // idx: ì•„ì´ì½˜ì˜ ìˆœë²ˆ(0..totalIcons-1) - "+n" ì œì™¸
  // totalIcons: í‘œì‹œ ì•„ì´ì½˜ ê°œìˆ˜(ìµœëŒ€ 5)
  // hasMore: +n ì¡´ì¬ ì—¬ë¶€

  // âœ… +nì´ ìˆìœ¼ë©´ (2,3)ì€ í•­ìƒ +nì´ ì“°ë¯€ë¡œ ì•„ì´ì½˜ì€ ê±°ê¸°ë¥¼ í”¼í•´ì„œ ë°°ì¹˜
  // ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¬ë¡¯:
  // - ìœ—ì¤„: (1,1)(1,2)(1,3)
  // - ì•„ë«ì¤„: (2,1)(2,2)  // (2,3)ì€ +n ê³ ì •

  let row, col;

  if(totalIcons <= 3){
    // ìœ—ì¤„ ì˜¤ë¥¸ìª½ ì •ë ¬: totalIcons=1 -> col3, 2 -> col2~3, 3 -> col1~3
    row = 1;
    const startCol = 4 - totalIcons; // 1->3, 2->2, 3->1
    col = startCol + idx;
  }else{
    // 4~5ê°œ: ì• 3ê°œëŠ” ìœ—ì¤„ 1~3 ê³ ì •
    if(idx < 3){
      row = 1;
      col = idx + 1;
    }else{
      // ë‚˜ë¨¸ì§€(1~2ê°œ)ëŠ” ì•„ë«ì¤„ ì˜¤ë¥¸ìª½ ì •ë ¬ BUT col3ì€ ë¹„ì›Œë‘ (+n)
      row = 2;
      const bottomCount = totalIcons - 3; // 1 or 2
      // ê°€ëŠ¥í•œ ì—´ì€ 1,2ë§Œ. ì˜¤ë¥¸ìª½ ì •ë ¬ ê¸°ì¤€:
      // bottomCount=1 -> col2
      // bottomCount=2 -> col1, col2
      const startCol = 3 - bottomCount; // 1->2, 2->1
      col = startCol + (idx - 3);
    }
  }

  node.style.gridRow = String(row);
  node.style.gridColumn = String(col);
}

function appendIconAt(badgesEl, node, idx, totalIcons, hasMore){
  setBadgeSlotFixedMore(node, idx, totalIcons, hasMore);
  badgesEl.appendChild(node);
}

function appendMoreFixed(badgesEl, moreNode){
  // âœ… +nì€ í•­ìƒ ì•„ë«ì¤„ ë§¨ ì˜¤ë¥¸ìª½ ê³ ì •
  moreNode.style.gridRow = "2";
  moreNode.style.gridColumn = "3";
  badgesEl.appendChild(moreNode);
}


/* âœ… ë‚´ìš© ìœ ë¬´ ë¬´ê´€: ë©”ëª¨/ì²´í¬ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í† ê¸€ */
function syncSections(){
  el("memoBody").classList.toggle("open", memoOpen);
  el("memoChev").textContent = memoOpen ? "â–²" : "â–¼";

  el("checkBody").classList.toggle("open", checkOpen);
  el("checkChev").textContent = checkOpen ? "â–²" : "â–¼";

  el("helpBody").classList.toggle("open", helpOpen);
  el("helpChev").textContent = helpOpen ? "â–²" : "â–¼";
}

el("memoHead").addEventListener("click", ()=>{
  memoOpen = !memoOpen;
  syncSections();
  if(memoOpen) setTimeout(()=> el("memo")?.focus(), 0);
});
el("checkHead").addEventListener("click", ()=>{
  checkOpen = !checkOpen;
  syncSections();
  if(checkOpen) setTimeout(()=> el("checkInput")?.focus(), 0);
});
el("helpHead").addEventListener("click", ()=>{
  helpOpen = !helpOpen;
  syncSections();
});

/* ------ ìŠ¤ì™€ì¹˜/ìŠ¤í‹°ì»¤ ------ */
function renderSwatches(){
  const sw = el("swatches");
  sw.innerHTML = "";
  COLORS.forEach(c=>{
    const div = document.createElement("div");
    div.className = "swatch" + (c.value===activeColor ? " active" : "");
    div.title = c.name;
    div.style.background = c.value || "#fff";
    div.addEventListener("click", ()=>{
      activeColor = c.value;
      if(!ensurePicked()) return;
      ensureDay(picked);
      state[picked].color = activeColor;
      saveState();
      render();
      renderSwatches();
    });
    sw.appendChild(div);
  });
}

function renderStickerRow(){
  const st = el("stickers");
  st.innerHTML = "";
  stickers.forEach(s=>{
    const btn = document.createElement("div");
    btn.className = "sticker" + (s===activeSticker ? " active" : "");
    btn.textContent = s || "ì—†ìŒ";
    btn.title = s ? "í´ë¦­: ì¶”ê°€/ì œê±°(í† ê¸€)" : "í´ë¦­: ì„ íƒ ë‚ ì§œ ìŠ¤í‹°ì»¤ ì „ì²´ ì œê±°";
    btn.addEventListener("click", ()=>{
      activeSticker = s;

      if(!ensurePicked()){
        renderStickerRow();
        return;
      }
      ensureDay(picked);

      if(activeSticker === ""){
        state[picked].stickers = [];
      }else{
        const arr = state[picked].stickers;
        const idx = arr.indexOf(activeSticker);
        if(idx >= 0) arr.splice(idx, 1);
        else arr.push(activeSticker);
      }

      saveState();
      renderPickedStickers();
      render();
      renderStickerRow();
    });
    st.appendChild(btn);
  });
}

/* ------ +n íˆ´íŒ ------ */
const tooltip = el("tooltip");
function showTooltip(x, y, dateKey){
  const list = state[dateKey]?.stickers || [];
  tooltip.innerHTML = `
    <div class="t">${dateKey} ì „ì²´ ìŠ¤í‹°ì»¤</div>
    <div class="s">${list.map(s=>`<span class="p">${escapeHtml(s)}</span>`).join("")}</div>
  `;
  tooltip.style.display = "block";
  moveTooltip(x,y);
}
function moveTooltip(x,y){
  if(tooltip.style.display !== "block") return;
  const pad = 12;
  const tx = Math.min(window.innerWidth - 20, x + pad);
  const ty = Math.min(window.innerHeight - 20, y + pad);
  tooltip.style.left = tx + "px";
  tooltip.style.top = ty + "px";
}
function hideTooltip(){
  tooltip.style.display = "none";
  tooltip.innerHTML = "";
}

/* ------ ì„ íƒ ë‚ ì§œ ìŠ¤í‹°ì»¤ chips ------ */
function renderPickedStickers(){
  const box = el("pickedStickers");
  box.innerHTML = "";
  if(!picked) return;
  const arr = state[picked]?.stickers || [];
  if(arr.length === 0) return;

  arr.forEach((s, idx)=>{
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerHTML = `<span>${escapeHtml(s)}</span><span class="x" title="ì‚­ì œ">âœ•</span>`;
    chip.querySelector(".x").addEventListener("click", ()=>{
      ensureDay(picked);
      state[picked].stickers.splice(idx, 1);
      saveState();
      renderPickedStickers();
      render();
    });
    box.appendChild(chip);
  });
}

/* ------ ì²´í¬ë¦¬ìŠ¤íŠ¸ ------ */
function renderChecklist(){
  const listEl = el("checkList");
  listEl.innerHTML = "";
  if(!picked) return;
  ensureDay(picked);
  const items = state[picked].checklist;

  items.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "check-item" + (it.done ? " done" : "");
    row.innerHTML = `
      <input type="checkbox" ${it.done ? "checked":""} />
      <label>${escapeHtml(it.text)}</label>
      <span class="del" title="ì‚­ì œ">âœ•</span>
    `;
    row.querySelector("input").addEventListener("change", (e)=>{
      it.done = e.target.checked;
      saveState();
      renderChecklist();
    });
    row.querySelector(".del").addEventListener("click", ()=>{
      items.splice(idx, 1);
      saveState();
      renderChecklist();
    });
    listEl.appendChild(row);
  });
}
function addChecklistItem(){
  if(!ensurePicked()) return;
  const v = el("checkInput").value.trim();
  if(!v) return;
  ensureDay(picked);
  state[picked].checklist.push({ text: v, done: false });
  el("checkInput").value = "";
  saveState();
  renderChecklist();
}
el("addCheckBtn").addEventListener("click", addChecklistItem);
el("checkInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    addChecklistItem();
  }
});

/* ------ ë©”ëª¨ ì €ì¥ ------ */
el("memo").addEventListener("input", ()=>{
  if(!picked) return;
  ensureDay(picked);
  state[picked].memo = el("memo").value;
  saveState();
});

/* ------ ë‹¬ë ¥ ë Œë” ------ */
function render(){
  const y = view.getFullYear();
  const m = view.getMonth();
  el("ym").innerHTML = `<b>${y}ë…„ ${m+1}ì›”</b>`;
  el("storageKey").textContent = STORAGE_KEY;

  const grid = el("grid");
  grid.innerHTML = "";

  const first = new Date(y, m, 1);
  const firstDow = first.getDay();
  const start = new Date(y, m, 1 - firstDow);

  const today = new Date();

  for(let i=0;i<42;i++){
    const d = new Date(start);
    d.setDate(start.getDate()+i);

    const key = fmtDate(d);
    const inMonth = d.getMonth()===m;
    const dow = d.getDay();
    const isHoliday = !!holidayName(key);
    const abbr = isHoliday ? holidayAbbr(key) : "";

    const cell = document.createElement("div");
    cell.className =
      "cell" +
      (inMonth ? "" : " out") +
      ((d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate()) ? " today" : "") +
      (picked===key ? " selected" : "") +
      (dow===0 ? " sun" : "") +
      (dow===6 ? " sat" : "") +
      (isHoliday ? " holiday" : "");

    cell.dataset.date = key;
    if(isHoliday) cell.title = holidayName(key);

    const saved = state[key];
    if(saved?.color){
      cell.style.background = saved.color;
    }

    const dateBlock = document.createElement("div");
    dateBlock.className = "date-block";

    const num = document.createElement("div");
    num.className = "num";
    num.textContent = d.getDate();
    dateBlock.appendChild(num);

    if(isHoliday){
      const a = document.createElement("div");
      a.className = "abbr";
      a.textContent = abbr;
      dateBlock.appendChild(a);
    }

    const badges = document.createElement("div");
    badges.className = "badges";

    const arr = saved?.stickers || [];

    // âœ… í‘œì‹œ ìŠ¤í‹°ì»¤ëŠ” "ìµœê·¼ 6ê°œ"ë¥¼ ì‚¬ìš© (ì¶”ê°€ UXì— ìì—°ìŠ¤ëŸ¬ì›€)
    const shown = arr.slice(-6);
    const remain = arr.length - 6;

    // âœ… ë°°ì¹˜ ê·œì¹™(ì˜¤â†’ì™¼, 2í–‰â†’1í–‰, 3ê°œ ë„˜ì–´ê°€ë©´ 2í–‰ì˜ 3ê°œê°€ 1í–‰ìœ¼ë¡œ ì˜¬ë¼ê°€ê³  2í–‰ì— ìƒˆë¡œ ì±„ì›€)
    const n = shown.length;

    // 1) ìŠ¤í‹°ì»¤ ë°°ì¹˜
    shown.forEach((s, i) => {
    const span = document.createElement("span");
    span.className = "badge";
    span.textContent = s;

    let row, col;

    if (n <= 3) {
        // n=1: (2,3) / n=2: (2,2)(2,3) / n=3: (2,1)(2,2)(2,3)
        row = 2;
        col = (4 - n) + i;          // 1->3, 2->2..3, 3->1..3
    } else {
        // ì²˜ìŒ 3ê°œëŠ” 1í–‰ 1~3 ê³ ì •ìœ¼ë¡œ "ì˜¬ë¼ê°"
        if (i < 3) {
        row = 1;
        col = i + 1;              // (1,1)(1,2)(1,3)
        } else {
        // ë‚˜ë¨¸ì§€(1~3ê°œ)ëŠ” 2í–‰ ì˜¤ë¥¸ìª½ë¶€í„° ì±„ì›€: n=4 -> (2,3), n=5 -> (2,2)(2,3), n=6 -> (2,1)(2,2)(2,3)
        row = 2;
        const bottomCount = n - 3;          // 1..3
        col = (4 - bottomCount) + (i - 3);  // 1->3, 2->2..3, 3->1..3
        }
    }

    span.style.gridRow = String(row);
    span.style.gridColumn = String(col);
    badges.appendChild(span);
    });

    // 2) +n ë°°ì¹˜: í•­ìƒ 9ë²ˆ ì¹¸(3í–‰ 3ì—´) ê³ ì •
    if (remain > 0) {
    const more = document.createElement("div");
    more.className = "more";
    more.textContent = `+${remain}`;

    more.style.gridRow = "3";
    more.style.gridColumn = "3";

    more.addEventListener("mouseenter", (e)=> showTooltip(e.clientX, e.clientY, key));
    more.addEventListener("mousemove", (e)=> moveTooltip(e.clientX, e.clientY));
    more.addEventListener("mouseleave", hideTooltip);

    badges.appendChild(more);
    }

    

    cell.appendChild(dateBlock);
    cell.appendChild(badges);

    cell.addEventListener("click", ()=>{
      picked = key;
      ensureDay(picked);

      el("pickedDate").textContent = formatKoreanDateLabel(picked);
      el("memo").value = state[picked].memo || "";

      renderPickedStickers();
      renderChecklist();

      // ìë™ ì˜¤í”ˆì€ ìœ ì§€í•˜ë˜, "í† ê¸€ ê°€ëŠ¥"ì´ë¼ ë¬¸ì œ ì—†ìŒ
      memoOpen = (state[picked].memo || "").trim().length > 0;
      checkOpen = (state[picked].checklist || []).length > 0;

      syncSections();
      render();
    });

    grid.appendChild(cell);
  }

  if(picked){
    ensureDay(picked);
    el("pickedDate").textContent = formatKoreanDateLabel(picked);
    el("memo").value = state[picked].memo || "";
    renderPickedStickers();
    renderChecklist();
  } else {
    el("pickedDate").textContent = "-";
    el("memo").value = "";
    el("pickedStickers").innerHTML = "";
    el("checkList").innerHTML = "";
  }

  syncSections();
}

/* ------ ì›” ì´ë™ / ì˜¤ëŠ˜(ì„ íƒê¹Œì§€) ------ */
function shiftMonth(delta){
  view.setMonth(view.getMonth()+delta);
  view.setDate(1);
  render();
}
function goTodaySelect(){
  const t = new Date();
  view = new Date(t.getFullYear(), t.getMonth(), 1);
  picked = fmtDate(t);
  ensureDay(picked);

  memoOpen = (state[picked].memo || "").trim().length > 0;
  checkOpen = (state[picked].checklist || []).length > 0;

  render();
}
el("prevBtn").addEventListener("click", ()=>shiftMonth(-1));
el("nextBtn").addEventListener("click", ()=>shiftMonth(1));
el("todayBtn").addEventListener("click", goTodaySelect);

function clearSelected(){
  if(!ensurePicked()) return;

  // âœ… confirm() ëŒ€ì‹  ëª¨ë‹¬
  pendingAction = () => {
    delete state[picked];
    saveState();
    ensureDay(picked);

    memoOpen = false;
    checkOpen = false;
    syncSections();

    render();
  };

  openConfirmModal(picked);
}

el("clearSelectedBtn").addEventListener("click", clearSelected);

/* ------ ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ------ */
function exportData(){
  const payload = { widgetId: WIDGET_ID, storageKey: STORAGE_KEY, state, customStickersKey: CUSTOM_STICKERS_KEY };
  const text = JSON.stringify(payload, null, 2);
  navigator.clipboard?.writeText(text).then(()=>{
    alert("í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”. (ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)");
  }).catch(()=>{
    prompt("ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:", text);
  });
}
function importData(){
  const raw = prompt("ë‚´ë³´ë‚¸ JSONì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:");
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    if(!parsed.state || typeof parsed.state!=="object") throw new Error("state ì—†ìŒ");
    state = parsed.state;

    for(const k of Object.keys(state)){
      const v = state[k];
      if(v && typeof v === "object"){
        if(Array.isArray(v.stickers) === false){
          const old = v.sticker;
          v.stickers = old ? [old] : [];
          delete v.sticker;
        }
        if(typeof v.memo !== "string") v.memo = "";
        if(typeof v.color !== "string") v.color = "";
        if(Array.isArray(v.checklist) === false) v.checklist = [];
      }
    }

    saveState();
    render();
    alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
  }catch(e){
    alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
  }
}
el("exportBtn").addEventListener("click", exportData);
el("importBtn").addEventListener("click", importData);

/* ------ ì»¤ìŠ¤í…€ ì´ëª¨ì§€ ------ */
function addCustomEmoji(){
  const raw = el("customEmoji").value.trim();
  if(!raw){
    alert("ì¶”ê°€í•  ì´ëª¨ì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    return;
  }
  let custom = [];
  try{
    const saved = localStorage.getItem(CUSTOM_STICKERS_KEY);
    custom = saved ? JSON.parse(saved) : [];
    if(!Array.isArray(custom)) custom = [];
  }catch{
    custom = [];
  }

  if(!custom.includes(raw) && !BASE_STICKERS.includes(raw)){
    custom.push(raw);
    saveCustomStickers(custom);
  }

  el("customEmoji").value = "";
}
function resetCustomStickers(){
  const ok = confirm("ì´ ìœ„ì ¯(id ê¸°ì¤€)ì˜ ì»¤ìŠ¤í…€ ìŠ¤í‹°ì»¤ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?");
  if(!ok) return;
  saveCustomStickers([]);
}
el("addEmojiBtn").addEventListener("click", addCustomEmoji);
el("resetStickersBtn").addEventListener("click", resetCustomStickers);
el("customEmoji").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    addCustomEmoji();
  }
});

renderSwatches();
renderStickerRow();
render();
</script>
</body>
</html>
